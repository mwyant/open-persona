services:
  openwebui:
    build:
      context: ./services/open-persona-openwebui
    image: open-persona-openwebui:local
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      # Preconfigure the built-in OpenAI provider to use the sidecar.
      # Open WebUI stores these in persistent config on first boot.
      - OPENAI_API_BASE_URLS=http://open-persona-sidecar:8000/v1
      - OPENAI_API_KEYS=sk-open-persona
      # Disable built-in Ollama polling unless explicitly needed.
      - ENABLE_OLLAMA_API=False
      # Admin defaults for Open Persona provider keys (fallback when user has none)
      - OPEN_PERSONA_DEFAULT_OPENAI_API_KEY=${OPEN_PERSONA_DEFAULT_OPENAI_API_KEY:-}
      - OPEN_PERSONA_DEFAULT_ANTHROPIC_API_KEY=${OPEN_PERSONA_DEFAULT_ANTHROPIC_API_KEY:-}
      - OPEN_PERSONA_DEFAULT_OPENROUTER_API_KEY=${OPEN_PERSONA_DEFAULT_OPENROUTER_API_KEY:-}
    ports:
      - "3000:8080"
    volumes:
      - "${DATA_OPENWEBUI:-./data/open-webui}:/app/backend/data"

  opencode:
    image: ghcr.io/sst/opencode:latest
    restart: unless-stopped
    # Image entrypoint is `opencode`, so command is subcommand args.
    command: ["serve", "--hostname", "0.0.0.0", "--port", "4096"]
    environment:
      # Configure providers by setting env vars here (PoC tradeoff A).
      # Example:
      # - ANTHROPIC_API_KEY=...
      # - OPENAI_API_KEY=...
      - XDG_CONFIG_HOME=/data/config
      - XDG_STATE_HOME=/data/state
    volumes:
      - "${DATA_OPENCODE:-./data/opencode}:/data"
      - "${WORKSPACES_DIR:-./workspaces}:/workspace/open-persona"
    working_dir: /workspace/open-persona

  instrumentl-mcp:
    build:
      context: ./services/instrumentl-mcp
    restart: unless-stopped
    environment:
      - MCP_PORT=7000
      # Placeholder; real key will be user-specific later.
      - INSTRUMENTL_API_KEY=
    ports:
      - "7000:7000"

  open-persona-sidecar:
    build:
      context: ./services/open-persona-sidecar
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      - PORT=8000
      - OPENCODE_BASE_URL=http://opencode:4096
      - WORKSPACE_ROOT=/workspace/open-persona
      # Runner mode:
      # - shared: use the single `opencode` service
      # - container: spawn `opencode serve` runner containers (requires docker socket)
      - RUNNER_MODE=shared
      - LOG_WORKSPACE_ROUTING=0
      - RUNNER_NETWORK=open-persona_default
      - RUNNER_IMAGE=ghcr.io/sst/opencode:latest
      - WORKSPACE_VOLUME=open-persona_open-persona-workspaces
      - OPENCODE_DATA_VOLUME=open-persona_opencode-data
      # Admin defaults for Open Persona provider keys (fallback)
      - OPEN_PERSONA_DEFAULT_OPENAI_API_KEY=${OPEN_PERSONA_DEFAULT_OPENAI_API_KEY:-}
      - OPEN_PERSONA_DEFAULT_ANTHROPIC_API_KEY=${OPEN_PERSONA_DEFAULT_ANTHROPIC_API_KEY:-}
      - OPEN_PERSONA_DEFAULT_OPENROUTER_API_KEY=${OPEN_PERSONA_DEFAULT_OPENROUTER_API_KEY:-}
    volumes:
      - "${WORKSPACES_DIR:-./workspaces}:/workspace/open-persona"
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8000:8000"
    depends_on:
      - opencode
      - instrumentl-mcp

# Using local bind mounts for persistent data in the repo directory
# Volumes not declared here; using ./data and ./workspaces directories
